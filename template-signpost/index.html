<!doctype html>
<html>
  <head>
    <title>sean's signpost</title>
    <meta name='author' content='sean'/>
    <script id='utils' type='text/javascript'>
      /*
      * load json file into js object
       */
      function loadJSON(jsonFile, callback) {   
        var xobj = new XMLHttpRequest();
        xobj.overrideMimeType('application/json');
        xobj.open('GET', jsonFile, true);
        xobj.onreadystatechange = function () {
          if (xobj.readyState == 4 && xobj.status == '200') {
            try {
              const res = JSON.parse(xobj.responseText);
              callback(res);
            } catch (err) {
              throw(`ERROR: while parsing json of ${jsonFile} got error ${err}`);
            }
          }
        };
        xobj.send();  
      }

      /*
      backup copyText function that relies on document.execCommand()
      which needs some text area on the page to copy from
      */
      function fallbackCopyTextToClipboard(text) {
        let textArea = document.createElement("textarea");
        textArea.value = text;

        // Avoid scrolling to bottom or right
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          const successful = document.execCommand('copy');
          const msg = successful ? 'successful' : 'unsuccessful';
          console.log('Fallback: Copying text command was ' + msg);
        } catch (err) {
          console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);
      }

      /*
      primary copyText function which relies on navigator.clipboard
      */
      function copyTextToClipboard(text) {
        if (!navigator.clipboard) {
          fallbackCopyTextToClipboard(text);
          return;
        }
        navigator.clipboard.writeText(text).then(() => {
          console.log('Async: Copying to clipboard was successful!');
        }, (err) => {
          console.error('Async: Could not copy text: ', err);
        });
      }
    </script>
    <style id='background-image'>
      li {
        display: list-item;
        list-style-type: circle;
      }
      body {
        background-color: pink;
        cursor: url('compass-cursor.svg');
      }
      .clipboardButton {
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <div id='landing-container'>
      <div id='nav-collection'></div>
    </div>
    <script>
      const clipboardImgPath = 'clipboard-outline.svg';

      function changeBackground(img) {
        var styleElem = document.getElementById('background-image');
        styleElem.innerHTML = `#landing-container::after { background-image: url('${img}'); }`;
      }

      function buildLinkBullet(bulletText) {
        let bullet = document.createElement('li');
        let link = document.createElement('a');
        link.setAttribute('href', 'https://' + bulletText);
        link.appendChild(document.createTextNode(bulletText));
        bullet.appendChild(link);
        return bullet;
      }

      function buildCodeBullet(bulletText) {
        let bullet = document.createElement('li');
        let code = document.createElement('code');
        code.appendChild(document.createTextNode(bulletText));
        let button = document.createElement('button');
        button.setAttribute('onclick', `copyTextToClipboard(\"${bulletText}\")`);
        button.setAttribute('class', 'clipboardButton');
        clipboardImg = document.createElement('img');
        clipboardImg.setAttribute('src', clipboardImgPath);
        clipboardImg.setAttribute('width', '13');
        clipboardImg.setAttribute('height', '13');
        button.appendChild(clipboardImg);
        bullet.appendChild(code);
        bullet.appendChild(button);
        return bullet;
      }

      function buildBullet(bulletText) {
        let bullet = document.createElement('li');
        bullet.appendChild(document.createTextNode(bulletText));
        return bullet;
      }

      const publicFields = ['name', 'description', 'url'];
      const privateFields = ['username', 'password'];

      class Website {
        constructor(websiteObj) {
          if (websiteObj.password != null) {
            this.private = {};
            // this is a private signpost
            privateFields.forEach((field) => {
              this.private[field] = websiteObj[field];
            });
          }
          this.public = {};
          publicFields.forEach((field) => {
            this.public[field] = websiteObj[field];
          });
        }

        getFields() {
          return (this.private != null) > 0
            ? {...this.public, ...this.private}
            : this.public;
        }
      }

      function buildHeader(name) {
        let header = document.createElement('h3');
        header.appendChild(document.createTextNode(name));
        return header;
      }


      const fieldToHtmlVisitor = {
        'name': (text) => buildHeader(text),
        'description': (text) => buildBullet(text),
        'url': (text) => buildLinkBullet(text),
        'username': (text) => buildCodeBullet(text),
        'password': (text) => buildCodeBullet(text),
      };

      function buildWebsiteCard(website) {
        let webCard = document.createElement('div');
        Object.entries(website.getFields()).forEach(([field, value]) => {
          webCard.appendChild(fieldToHtmlVisitor[field](value));
        });
        return webCard;
      }

      loadJSON('signpost.json', (signpost) => {
        let nav = document.getElementById('nav-collection');
        signpost.forEach(websiteObj => {
          const website = new Website(websiteObj);
          nav.appendChild(buildWebsiteCard(website));
        });
      });

    </script>
  </body>
</html>
